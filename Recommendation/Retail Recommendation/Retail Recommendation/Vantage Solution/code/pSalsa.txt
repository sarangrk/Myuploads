----pSalsa -----



drop table loblaws.user_product_nodes_tmp;

create TABLE loblaws.user_product_nodes_tmp   as

(SELECT  
    nodename
FROM 
(
select distinct product as nodename from loblaws.pos_cluster_new
UNION ALL
select distinct customer_id as nodename from loblaws.pos_cluster_new
) x)
with data;


select * from loblaws.user_product_nodes_tmp




drop table loblaws.user_product_nodes ;

create table loblaws.user_product_nodes 
as (
SELECT ROW_NUMBER() OVER (ORDER BY tab1.nodename) as nodeid,
tab1.nodename as nodename
FROM loblaws.user_product_nodes_tmp tab1) with data;

select * from  loblaws.user_product_nodes



--input tables

drop table  loblaws.user_product_log ;


create TABLE loblaws.user_product_log as
(select customer_id as username
      ,product as product
      ,count(1) as frequency
from loblaws.pos_cluster_new
group by customer_id , product)
with data;

select * from loblaws.user_product_log



drop table loblaws.user_product_nodes_new

create table loblaws.user_product_nodes_new as
(select cast(nodeid as VARCHAR(100)) as nodeid,
cast(nodename as VARCHAR(200)) as nodename


from loblaws.user_product_nodes)
with data




drop table loblaws.user_product_log_new

create table loblaws.user_product_log_new as
(select cast(username as VARCHAR(200)) as userid,
cast(product as VARCHAR(200)) as product,
frequency


from loblaws.user_product_log)
with data


select * from loblaws.user_product_log_new


create table loblaws.user_product_salsa as
(
SELECT * FROM PSALSA (
ON loblaws.user_product_nodes_new AS vertices PARTITION BY nodename
ON loblaws.user_product_log_new AS edges PARTITION BY userid

USING  SourceKey ('userid')
TargetKey ('product')
EdgeWeight ('frequency')
MaxHubNum (2)
MaxAuthorityNum (2)
TeleportProb (0.15)
RandomWalkLength (500) ) AS dt

) with data;



select * from loblaws.user_product_salsa where userid='100725'


 
select * from loblaws.user_product_salsa

--name--u_u_affinity
select   ('[' || userid || ',' || hub_userid || ']') as path
  ,hub_score as cnt;
FROM loblaws.user_product_salsa where path is not null
--name--u_p_affinity
select   ('[' || userid || ',' || authority_product || ']') as path
  ,authority_score as cnt;
FROM loblaws.user_product_salsa where path is not null
