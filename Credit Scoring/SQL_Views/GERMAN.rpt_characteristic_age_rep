REPLACE VIEW GERMAN.rpt_characteristic_age_rep
AS LOCKING ROW FOR ACCESS
SELECT
	SRC.YEAR_MONTH as year_month
	,cast(SRC.YEAR_OF_CALENDAR as varchar(20)) || ' quarter ' || cast(SRC.QUARTER_OF_YEAR as varchar(20)) as calendar_period
	,case when age like '%++' then src.high_val else coalesce(SRC.LOWER_VAL,0) end as lower_val
	,SRC.HIGH_VAL as high_val
	,CASE 
		WHEN SRC.BIN_ID = 0 AND SRC.LOWER_VAL IS NULL THEN '0 - ' || TRIM(SRC.HIGH_VAL)
		WHEN SRC.BIN_ID = (SELECT MAX(BIN_ID) FROM GERMAN.TBL_ACCOUNT_SCORING_FINE_BINS WHERE VARNAME='NUMAGE')
			AND SRC.LOWER_VAL IS NULL THEN TRIM(SRC.HIGH_VAL) || '++'
		ELSE TRIM(SRC.LOWER_VAL) || ' - ' || TRIM(SRC.HIGH_VAL)
	END AS age 
	,cast(POINTS.score as integer) as score
	,SUM(SRC.EXPECTED_PCT) as dstr
	,SUM(SRC.GOODS) as goods
	,SUM(SRC.BADS) as bads
	,cast(sum(cast(src.bads as decimal(32,4))) / sum(cast(src.expected_count as decimal(32,4))) * 100 as decimal(32,2)) as bad_rate
FROM
(
SELECT     
	PREV.YEAR_MONTH
	,CAL.YEAR_OF_CALENDAR
	,CAL.QUARTER_OF_YEAR
	,CAL.CALENDAR_DATE
	,CAST(TRIM(PREV.BIN_ID) AS SMALLINT) AS BIN_ID
	,PREV.VARNAME
	,AGE.LOWER_VAL
	,AGE.HIGH_VAL
	,AGE.LABEL AS LABEL
	,ACCT_COUNT.ACCOUNT_COUNT AS COUNT_PER_QTR
	,COUNT(PREV.ACCT_ID) AS EXPECTED_COUNT
	,CAST((CAST(EXPECTED_COUNT AS DECIMAL(32,4)) / CAST(COUNT_PER_QTR AS DECIMAL(32,4))) * 100 AS DECIMAL(32,2)) AS EXPECTED_PCT
	,CASE WHEN PRF.PRFGRP = 7 THEN SUM(1) ELSE 0 END AS GOODS
    ,CASE WHEN PRF.PRFGRP = 3 THEN SUM(1) ELSE 0 END AS BADS

FROM GERMAN.TBL_ACCOUNT_SCORING_FINE_BINS PREV      

LEFT JOIN GERMAN.TBL_ACCOUNT_SCORE ACT_SCORE
ON PREV.ACCT_ID = ACT_SCORE.ACCT_ID
AND PREV.YEAR_MONTH = ACT_SCORE.YEAR_MONTH
	
LEFT JOIN GERMAN.CAL_YEAR_MONTH CAL
ON PREV.YEAR_MONTH=CAL.YEAR_MONTH

LEFT JOIN 
(
	SELECT
		YEAR_MONTH
		,COUNT(ACCT_ID) AS ACCOUNT_COUNT
	FROM GERMAN.TBL_ACCOUNT_SCORE
	GROUP BY 1
) ACCT_COUNT
ON PREV.YEAR_MONTH = ACCT_COUNT.YEAR_MONTH

LEFT JOIN GERMAN.V_AGE_BIN AGE
ON PREV.BIN_ID = AGE.BIN_ID

LEFT JOIN GERMAN.tbl_account_prfgrp PRF
ON PREV.ACCT_ID = PRF.ACCT_ID
AND PREV.YEAR_MONTH = PRF.YEAR_MONTH

WHERE PREV.VARNAME = 'NUMAGE'
--AND PREV.YEAR_MONTH = 201612

GROUP BY
	PREV.YEAR_MONTH
	,CAL.YEAR_OF_CALENDAR
	,CAL.QUARTER_OF_YEAR
	,CAL.CALENDAR_DATE
	,PREV.BIN_ID
	,PREV.VARNAME
	,AGE.LOWER_VAL
	,AGE.HIGH_VAL
	,AGE.LABEL
	,ACCT_COUNT.ACCOUNT_COUNT
	,PRF.PRFGRP

) SRC 

LEFT JOIN 
(
	SELECT * FROM GERMAN.TBL_SEG_SCORECARD
	WHERE VARNAME = 'NUMAGE'
	QUALIFY ROW_NUMBER() OVER(PARTITION BY VARNAME,OLD_BIN_ID ORDER BY SEGMENT_GROUP DESC) = 1
) POINTS

ON SRC.BIN_ID = POINTS.OLD_BIN_ID

GROUP BY 
	SRC.YEAR_MONTH
	,SRC.YEAR_OF_CALENDAR
	,SRC.QUARTER_OF_YEAR
	,SRC.BIN_ID
	,SRC.LOWER_VAL
	,SRC.HIGH_VAL
	,SRC.LABEL
	,POINTS.SCORE;
